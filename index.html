<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Bodhi 🌱</title>
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffc300">
    <link rel="icon" href="assets/images/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="assets/images/icon-192x192.png">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <script>
        // Check setup status and handle existing users
        const setupComplete = localStorage.getItem('bodhiSetupComplete');
        const hasExistingData = localStorage.getItem('profiles') || localStorage.getItem('gemini_api_key');
        const hasPinSetup = localStorage.getItem('parentalPin');

        if (!setupComplete) {
            if (hasExistingData) {
                // Existing user without proper setup - force reset
                window.location.href = 'force-reset.html';
            } else {
                // New user - go to welcome
                window.location.href = 'welcome.html';
            }
        } else if (!hasPinSetup) {
            // User has setup but no PIN - force PIN setup
            window.location.href = 'force-reset.html';
        }
        // If setup complete and PIN exists, continue to main app
    </script>
</head>
<body>
    <div class="background-shapes">
        <div class="shape shape1"></div>
        <div class="shape shape2"></div>
        <div class="shape shape3"></div>
        <div class="shape shape4"></div>
        <div class="shape shape5"></div>
        <div class="emoji" style="left: 5%; animation-duration: 22s; font-size: 2.5em;">📚</div>
        <div class="emoji" style="left: 15%; animation-duration: 18s; font-size: 2em;">🐝</div>
        <div class="emoji" style="left: 20%; animation-duration: 25s; font-size: 3em;">🌈</div>
        <div class="emoji" style="left: 35%; animation-duration: 15s; font-size: 2.2em;">🧩</div>
        <div class="emoji" style="left: 55%; animation-duration: 20s; font-size: 2.8em;">🎨</div>
        <div class="emoji" style="left: 70%; animation-duration: 16s; font-size: 2.1em;">✨</div>
        <div class="emoji" style="left: 85%; animation-duration: 24s; font-size: 2.6em;">🍎</div>
        <div class="emoji" style="left: 95%; animation-duration: 19s; font-size: 2.3em;">🦋</div>
    </div>
    <div class="app-container">
        <header>
            <h1>Bodhi 🌱</h1>
        </header>

        <!-- Main View for Kids -->
        <div id="main-view">
            <div id="welcome-screen" class="card">
                <h2>Welcome!</h2>
                <p>Please select your profile to start your adventure!</p>
                <button id="select-profile-btn" class="btn-primary">Select Profile</button>
            </div>

            <div id="main-app" class="hidden">
                <div class="app-header">
                    <button id="back-btn" class="btn-secondary hidden">⬅️ Back</button>
                    <h2 id="welcome-message"></h2>
                </div>
                <div id="module-selection" class="card">
                    <h3>Choose Your Adventure!</h3>
                    <div class="tab-bar">
                        <button class="tab-btn active" data-category="school">🏫 School Time</button>
                        <button class="tab-btn" data-category="word">🔡 Word Play</button>
                        <button class="tab-btn" data-category="tech">🤖 Tech Lab</button>
                    </div>
                    <div class="module-buttons">
                        <button class="module-btn" data-module="reading">📚 Reading</button>
                        <button class="module-btn" data-module="math">🧮 Math</button>
                        <button class="module-btn" data-module="logic">🧠 Logic</button>
                        <button class="module-btn" data-module="rhyming">🎤 Rhyming</button>
                        <button class="module-btn" data-module="spelling">SPELLING</button>
                        <button class="module-btn" data-module="emoji-riddles">🤔 Emoji Riddles</button>
                        <button class="module-btn" data-module="coding">💻 Coding</button>
                        <button class="module-btn" data-module="ai">🤖 AI</button>
                        <button class="module-btn" data-module="science">🔬 Science</button>
                        <button class="module-btn" data-module="phonics">🗣️ Phonics</button>
                    </div>
                </div>
                <div id="theme-selection" class="card hidden">
                    <h3 id="theme-selection-title"></h3>
                    <div class="difficulty-slider">
                        <label for="difficulty">Difficulty: <span id="difficulty-label">1</span></label>
                        <div class="slider-container">
                            <span>😊</span>
                            <input type="range" id="difficulty" min="1" max="5" value="1">
                            <span>🧠</span>
                        </div>
                    </div>
                    <div id="theme-buttons" class="module-buttons">
                        <!-- Theme buttons will be dynamically inserted here -->
                    </div>
                </div>
                <div id="module-container" class="hidden">
                    <div id="module-view" class="card">
                        <h3 id="module-title"></h3>
                        <div class="loader"></div>
                        <div id="story-content"></div>
                        <div id="questions-container"></div>
                        <div id="score-container" class="hidden">
                            <h4>Your Score: <span id="score">0</span></h4>
                        </div>
                        <button id="submit-answers-btn" class="btn-primary hidden">Submit Answers</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button for Settings -->
    <button id="settings-fab" class="fab">⚙️</button>
    <button id="exit-to-profile-btn" class="fab fab-exit hidden">🏠</button>

    <!-- Settings Page Modal -->
    <div id="settings-modal" class="modal-container fullscreen-modal hidden">
        <div class="modal-content card settings-page">
            <h2>⚙️ Parent Settings</h2>
            <div id="api-key-section">
                <h3>🔑 Gemini API Key</h3>
                <input type="text" id="api-key" placeholder="Enter your API key">
                <p class="api-key-info">Get a free key from <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer">Google AI Studio</a>.
                    <br>The free tier is very generous, allowing for over 50 learning modules per day.
                </p>
            </div>
            <hr>
            <div id="profile-management-section">
                <h3>👤 Manage Profiles</h3>
                <div id="profiles-list-settings"></div>
                <div id="profile-creation" class="hidden">
                    <h4>Create New Profile</h4>
                    <input type="text" id="name" placeholder="Name">
                    <input type="number" id="age" placeholder="Age">
                </div>
                <button id="add-profile-btn" class="btn-secondary">✨ Add New Profile</button>
            </div>
            <div id="progress-tracking-section">
                <h3>📊 Learning Progress</h3>
                <select id="progress-profile-select">
                    <option value="">Select a profile</option>
                </select>
                <div id="progress-stats"></div>
            </div>
            <hr>
            <div id="reset-section">
                <h3>🔄 Reset App</h3>
                <div class="reset-toggle-container">
                    <button id="toggle-reset-btn" class="toggle-btn">Show Reset Options</button>
                </div>
                <div id="reset-options" class="reset-options hidden">
                    <p class="warning-text">⚠️ <strong>Danger Zone:</strong> This will permanently delete all profiles, progress data, API keys, and settings. The app will restart with the welcome setup.</p>
                    <div class="reset-confirmation">
                        <p class="confirm-text">Are you sure? This action cannot be undone.</p>
                        <button id="reset-app-btn" class="btn-danger-small">Reset Everything</button>
                    </div>
                </div>
            </div>
            <div class="settings-footer">
                <p>Made by <a href="https://simkeyur.github.io" target="_blank" rel="noopener noreferrer">Keyur</a>. Suggestions are welcome!</p>
            </div>
            <button id="save-settings-btn" class="btn-primary">Save & Close</button>
            <p id="safari-homescreen-info" class="hidden">For the best experience on Safari, please add this app to your Home Screen.</p>
        </div>
    </div>

    <!-- Kids Profile Selection Modal -->
    <div id="profile-selection-modal" class="modal-container hidden">
        <div class="modal-content card">
            <h2>Who's Learning Today?</h2>
            <div id="profiles-list-kids"></div>
            <button id="close-profile-selection-btn" class="btn-close">✖</button>
        </div>
    </div>

    <!-- Reusable Parental Gate Modal -->
    <div id="parental-gate-modal" class="modal-container hidden">
        <div class="modal-content card">
            <h2>🔒 Are you a grown-up?</h2>
            <p>To continue, please answer this question:</p>
            <p id="parental-question"></p>
            <input type="number" id="parental-answer" placeholder="Your answer">
            <p id="parental-error-message" class="error-message hidden">Incorrect answer. Please try again.</p>
            <button id="submit-parental-answer-btn" class="btn-primary">Confirm</button>
            <button id="close-parental-gate-btn" class="btn-close">✖</button>
        </div>
    </div>

    <!-- PIN Entry Modal -->
    <div id="pin-entry-modal" class="modal-container hidden">
        <div class="modal-content card">
            <h2>🔐 Enter Parental PIN</h2>
            <p>Please enter your 4-digit PIN to access parental controls.</p>
            <div class="pin-input-section">
                <div class="pin-digits">
                    <input type="password" class="pin-digit" maxlength="1" data-index="0">
                    <input type="password" class="pin-digit" maxlength="1" data-index="1">
                    <input type="password" class="pin-digit" maxlength="1" data-index="2">
                    <input type="password" class="pin-digit" maxlength="1" data-index="3">
                </div>
                <button type="button" id="toggle-pin-entry-visibility" class="btn-secondary">Show PIN</button>
            </div>
            <p id="pin-error-message" class="error-message hidden">Incorrect PIN. Please try again.</p>
            <div class="step-actions">
                <button id="forgot-pin-btn" class="btn-secondary">Forgot PIN?</button>
                <button id="submit-pin-btn" class="btn-primary">Confirm</button>
            </div>
            <button id="close-pin-entry-btn" class="btn-close">✖</button>
        </div>
    </div>

    <!-- PIN Recovery Modal -->
    <div id="pin-recovery-modal" class="modal-container hidden">
        <div class="modal-content card">
            <h2>🔑 Recover Your PIN</h2>
            <p>Please answer your recovery questions to reset your PIN.</p>
            <div id="recovery-questions-container"></div>
            <p id="recovery-error-message" class="error-message hidden">Incorrect answers. Please try again.</p>
            <div class="helper-info">
                <p><strong>🔄 Forgot your security questions?</strong></p>
                <p>You can perform a hard reset by deleting this app from your device and re-installing by visiting <strong>bodhikids.github.io</strong></p>
            </div>
            <div class="step-actions">
                <button id="back-to-pin-btn" class="btn-secondary">Back</button>
                <button id="submit-recovery-btn" class="btn-primary">Reset PIN</button>
            </div>
            <button id="close-pin-recovery-btn" class="btn-close">✖</button>
        </div>
    </div>

    <!-- PIN Reset Modal -->
    <div id="pin-reset-modal" class="modal-container fullscreen-modal hidden">
        <div class="modal-content card">
            <div class="settings-page">
                <h2>🔑 Reset Your PIN</h2>
                <p>Create a new PIN to protect parental settings.</p>

                <div class="pin-setup-section">
                    <div class="pin-input-section">
                        <h3>1. Create Your New PIN</h3>
                        <div class="pin-digits">
                            <input type="password" class="pin-digit-reset" maxlength="1" inputmode="numeric" pattern="[0-9]" placeholder="•" />
                            <input type="password" class="pin-digit-reset" maxlength="1" inputmode="numeric" pattern="[0-9]" placeholder="•" />
                            <input type="password" class="pin-digit-reset" maxlength="1" inputmode="numeric" pattern="[0-9]" placeholder="•" />
                            <input type="password" class="pin-digit-reset" maxlength="1" inputmode="numeric" pattern="[0-9]" placeholder="•" />
                        </div>
                        <button type="button" id="toggle-reset-pin-visibility" class="btn-secondary">Show PIN</button>
                        <p class="helper-text">This PIN will be used to access parental settings</p>
                    </div>

                    <div class="recovery-section">
                        <h3>2. Update Recovery Questions</h3>
                        <p class="helper-text">Answer these questions to recover your PIN if forgotten</p>

                        <div class="recovery-questions">
                            <div class="question-card">
                                <div class="question">What is your favorite color?</div>
                                <input type="text" id="reset-recovery-color" class="answer-input" placeholder="Your answer" autocomplete="off" />
                            </div>

                            <div class="question-card">
                                <div class="question">What city were you born in?</div>
                                <input type="text" id="reset-recovery-city" class="answer-input" placeholder="Your answer" autocomplete="off" />
                            </div>

                            <div class="question-card">
                                <div class="question">What is your favorite sports team?</div>
                                <input type="text" id="reset-recovery-team" class="answer-input" placeholder="Your answer" autocomplete="off" />
                            </div>
                        </div>
                    </div>
                </div>

                <p id="reset-pin-error-message" class="error-message hidden">Please fill in all fields</p>
            </div>
            
            <!-- Fixed buttons with proper spacing -->
            <div class="step-actions">
                <button id="cancel-pin-reset-btn" class="btn-secondary">Cancel</button>
                <button id="save-reset-pin-btn" class="btn-primary">Update PIN</button>
            </div>
        </div>
    </div>

    <!-- Add Profile Modal -->
    <div id="add-profile-modal" class="modal-container hidden">
        <div class="modal-content card">
            <h2>✨ Add New Profile</h2>
            <input type="text" id="add-profile-name" placeholder="Enter child's name">
            <input type="number" id="add-profile-age" placeholder="Enter age (3-15)" min="3" max="15">
            <div class="button-group">
                <button id="save-add-profile-btn" class="btn-primary">Add Profile</button>
                <button id="cancel-add-profile-btn" class="btn-secondary">Cancel</button>
            </div>
            <button id="close-add-profile-btn" class="btn-close">✖</button>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="modal-container hidden">
        <div class="modal-content card">
            <h2>✏️ Edit Profile</h2>
            <input type="text" id="edit-name" placeholder="Enter Name">
            <input type="number" id="edit-age" placeholder="Enter Age (3-15)" min="3" max="15">
            <button id="save-edit-profile-btn" class="btn-primary">Save Changes</button>
            <button id="close-edit-modal-btn" class="btn-close">✖</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    
    <!-- Notyf Toast Library -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    
    <script type="module" src="js/app.js"></script>
    <script type="module" src="js/gemini.js"></script>
    <script type="module" src="js/prompts.js"></script>
    <script type="module" src="js/ui.js"></script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>

    <!-- Add to Home Screen Banner for iOS -->
    <div id="add-to-home-screen-banner" class="hidden">
        <p>For the best experience, add Bodhi to your Home Screen! <br><small>(Tap the Share button, then 'Add to Home Screen')</small></p>
        <button id="close-banner-btn">✖</button>
    </div>
</body>
</html>